<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŠ´åƒè¡›ç”Ÿã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ å£è¿°è©¦é¨“å¯¾ç­–</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
    const STORAGE_KEYS = {
      review: 'ohc-exam-review-items',
      addedMainThemes: 'ohc-exam-added-main-themes',      // æœ¬ç·¨ã«è¿½åŠ ã—ãŸå•é¡Œ
      addedAdditionalQs: 'ohc-exam-added-additional-qs'   // è¿½åŠ å•é¡Œç·¨ã«è¿½åŠ ã—ãŸå•é¡Œ
    };

    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼
    const parseQuestionsMarkdown = (markdown) => {
      const themes = [];
      let currentTheme = null;
      let currentQuestion = null;
      let currentSection = null;
      
      const lines = markdown.split('\n');
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        const themeMatch = line.match(/^##\s*(?:ãƒ†ãƒ¼ãƒ\d+[ï¼š:]\s*)?(.+?)$/);
        if (themeMatch && !line.includes('ã€äºˆæƒ³å•é¡Œ') && !line.includes('ç¬¬') && !line.includes('ç« ')) {
          if (currentTheme && currentTheme.questions.length > 0) {
            themes.push(currentTheme);
          }
          currentTheme = { id: themes.length + 1, name: themeMatch[1].trim(), questions: [] };
          currentQuestion = null;
          continue;
        }
        
        const questionMatch = line.match(/\*\*Q\d+[ï¼ˆ(](åŸºæœ¬|è©³ç´°|å¿œç”¨)å•é¡Œ[ï¼‰)][ï¼š:]\*\*/);
        if (questionMatch && currentTheme) {
          if (currentQuestion) currentTheme.questions.push(currentQuestion);
          currentQuestion = { level: questionMatch[1], question: '', modelAnswer: '', keyPoints: [], followUpQuestions: [] };
          currentSection = 'question';
          continue;
        }
        
        if (line.includes('ã€æ¨¡ç¯„è§£ç­”ã€‘')) { currentSection = 'modelAnswer'; continue; }
        if (line.includes('è©¦é¨“å®˜ãŒè¦‹ã¦ã„ã‚‹ãƒã‚¤ãƒ³ãƒˆ')) { currentSection = 'keyPoints'; continue; }
        if (line.includes('æƒ³å®šã•ã‚Œã‚‹è¿½åŠ è³ªå•')) { currentSection = 'followUp'; continue; }
        if (line.trim() === '---' || line.trim() === '') continue;
        if (line.includes('ã€äºˆæƒ³å•é¡Œ')) {
          if (currentQuestion) { currentTheme.questions.push(currentQuestion); currentQuestion = null; }
          continue;
        }
        
        if (currentQuestion && currentSection) {
          const cleanLine = line.trim();
          if (!cleanLine) continue;
          
          if (currentSection === 'question' && !cleanLine.startsWith('**') && !cleanLine.startsWith('#')) {
            currentQuestion.question += (currentQuestion.question ? ' ' : '') + cleanLine;
          } else if (currentSection === 'modelAnswer' && !cleanLine.startsWith('**') && !cleanLine.startsWith('#')) {
            currentQuestion.modelAnswer += (currentQuestion.modelAnswer ? '\n' : '') + cleanLine;
          } else if (currentSection === 'keyPoints' && (cleanLine.startsWith('-') || cleanLine.startsWith('ãƒ»'))) {
            currentQuestion.keyPoints.push(cleanLine.replace(/^[-ãƒ»]\s*/, ''));
          } else if (currentSection === 'followUp' && (cleanLine.startsWith('-') || cleanLine.startsWith('ãƒ»'))) {
            currentQuestion.followUpQuestions.push(cleanLine.replace(/^[-ãƒ»]\s*/, '').replace(/[ã€Œã€]/g, ''));
          }
        }
      }
      
      if (currentQuestion && currentTheme) currentTheme.questions.push(currentQuestion);
      if (currentTheme && currentTheme.questions.length > 0) themes.push(currentTheme);
      
      return themes;
    };

    const parseFollowUpMarkdown = (markdown) => {
      const followUps = {};
      let currentQuestion = null;
      let currentAnswer = '';
      
      const lines = markdown.split('\n');
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        const questionMatch = line.match(/^###\s*Q[ï¼š:]\s*(.+)$/);
        if (questionMatch) {
          if (currentQuestion && currentAnswer) followUps[currentQuestion] = currentAnswer.trim();
          currentQuestion = questionMatch[1].trim();
          currentAnswer = '';
          continue;
        }
        
        const answerMatch = line.match(/^\*\*A[ï¼š:]\*\*\s*(.*)$/);
        if (answerMatch) { currentAnswer = answerMatch[1]; continue; }
        if (line.trim() === '---' || line.startsWith('## ') || line.trim() === '') continue;
        if (currentQuestion && !line.startsWith('#') && !line.startsWith('**')) {
          currentAnswer += ' ' + line.trim();
        }
      }
      
      if (currentQuestion && currentAnswer) followUps[currentQuestion] = currentAnswer.trim();
      return followUps;
    };

    function App() {
      const [appMode, setAppMode] = useState('loading');
      
      // æœ¬ç·¨ï¼ˆquestions.mdã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
      const [mainThemes, setMainThemes] = useState([]);
      // æœ¬ç·¨ã«è¿½åŠ ã—ãŸå•é¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•è¿½åŠ ï¼‰
      const [addedMainThemes, setAddedMainThemes] = useState([]);
      // è¿½åŠ å•é¡Œç·¨ï¼ˆfollowup.mdã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
      const [additionalFollowUps, setAdditionalFollowUps] = useState({});
      // è¿½åŠ å•é¡Œç·¨ã«è¿½åŠ ã—ãŸå•é¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•è¿½åŠ ï¼‰
      const [addedAdditionalQs, setAddedAdditionalQs] = useState({});
      
      // å¾©ç¿’ãƒ•ã‚©ãƒ«ãƒ€
      const [reviewItems, setReviewItems] = useState([]);
      
      // è©¦é¨“ã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆé¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ãï¼‰
      const [activeThemes, setActiveThemes] = useState([]);
      const [activeFollowUps, setActiveFollowUps] = useState({});
      const [examMode, setExamMode] = useState(null); // 'main', 'additional', 'custom', 'review'
      
      // è©¦é¨“çŠ¶æ…‹
      const [gameState, setGameState] = useState('start');
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [currentThemeIndex, setCurrentThemeIndex] = useState(0);
      const [currentQuestionLevel, setCurrentQuestionLevel] = useState(0);
      const [completedThemes, setCompletedThemes] = useState([]);
      const [scores, setScores] = useState([]);
      const [totalScore, setTotalScore] = useState(0);
      const [followUpQuestion, setFollowUpQuestion] = useState(null);
      const [usedThemes, setUsedThemes] = useState([]);
      const [takeHomeCount, setTakeHomeCount] = useState(0);
      const [takeHomeThemes, setTakeHomeThemes] = useState([]);
      const [currentReviewIndex, setCurrentReviewIndex] = useState(0);
      const MAX_TAKE_HOME = 2;
      
      // ç®¡ç†ç”»é¢
      const [adminTab, setAdminTab] = useState('addMain');
      const [newTheme, setNewTheme] = useState({
        name: '',
        questions: [
          { level: 'åŸºæœ¬', question: '', modelAnswer: '', keyPoints: [''], followUpQuestions: [''] },
          { level: 'è©³ç´°', question: '', modelAnswer: '', keyPoints: [''], followUpQuestions: [''] },
          { level: 'å¿œç”¨', question: '', modelAnswer: '', keyPoints: [''], followUpQuestions: [''] }
        ]
      });
      const [newFollowUp, setNewFollowUp] = useState({ question: '', answer: '' });
      
      const messagesEndRef = useRef(null);

      // åˆæœŸåŒ–
      useEffect(() => {
        const loadData = async () => {
          try {
            // localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
            const savedReview = localStorage.getItem(STORAGE_KEYS.review);
            const savedAddedMain = localStorage.getItem(STORAGE_KEYS.addedMainThemes);
            const savedAddedAdditional = localStorage.getItem(STORAGE_KEYS.addedAdditionalQs);
            
            if (savedReview) setReviewItems(JSON.parse(savedReview));
            if (savedAddedMain) setAddedMainThemes(JSON.parse(savedAddedMain));
            if (savedAddedAdditional) setAddedAdditionalQs(JSON.parse(savedAddedAdditional));
            
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆæœ¬ç·¨ï¼‰
            const questionsRes = await fetch('./data/questions.md').catch(() => null);
            if (questionsRes && questionsRes.ok) {
              const text = await questionsRes.text();
              const parsed = parseQuestionsMarkdown(text);
              if (parsed.length > 0) setMainThemes(parsed);
            }
            
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆè¿½åŠ å•é¡Œç·¨ï¼‰
            const followUpRes = await fetch('./data/followup.md').catch(() => null);
            if (followUpRes && followUpRes.ok) {
              const text = await followUpRes.text();
              const parsed = parseFollowUpMarkdown(text);
              if (Object.keys(parsed).length > 0) setAdditionalFollowUps(parsed);
            }
            
            setAppMode('menu');
          } catch (err) {
            console.error('Load error:', err);
            setAppMode('menu');
          }
        };
        loadData();
      }, []);

      // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
      useEffect(() => {
        if (appMode !== 'loading') {
          localStorage.setItem(STORAGE_KEYS.review, JSON.stringify(reviewItems));
          localStorage.setItem(STORAGE_KEYS.addedMainThemes, JSON.stringify(addedMainThemes));
          localStorage.setItem(STORAGE_KEYS.addedAdditionalQs, JSON.stringify(addedAdditionalQs));
        }
      }, [reviewItems, addedMainThemes, addedAdditionalQs, appMode]);

      const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      useEffect(() => { scrollToBottom(); }, [messages]);

      const addMessage = (role, content) => setMessages(prev => [...prev, { role, content }]);

      // æ¡ç‚¹API
      const gradeAnswer = async (question, modelAnswer, keyPoints, userAnswer) => {
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1000,
              system: `ã‚ãªãŸã¯åŠ´åƒè¡›ç”Ÿã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆå£è¿°è©¦é¨“ã®æ¡ç‚¹è€…ã§ã™ã€‚10ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚
ã€æ¡ç‚¹åŸºæº–ã€‘10ç‚¹:å®Œç’§ 8-9ç‚¹:å„ªç§€ 6-7ç‚¹:åˆæ ¼ 4-5ç‚¹:ä¸€éƒ¨æ­£è§£ 2-3ç‚¹:æ–¹å‘æ€§ã®ã¿ 0-1ç‚¹:çš„å¤–ã‚Œ
å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ï¼š
ç‚¹æ•°: [0-10]
è¬›è©•: [100å­—ä»¥å†…]`,
              messages: [{
                role: "user",
                content: `ã€å•é¡Œã€‘${question}\nã€æ¨¡ç¯„è§£ç­”ã€‘${modelAnswer}\nã€ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã€‘${(keyPoints || []).join(', ')}\nã€å—é¨“è€…ã®å›ç­”ã€‘${userAnswer}\n\næ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚`
              }]
            })
          });
          const data = await response.json();
          const text = data.content[0].text;
          const scoreMatch = text.match(/ç‚¹æ•°[:ï¼š]\s*(\d+)/);
          const feedbackMatch = text.match(/è¬›è©•[:ï¼š]\s*(.+)/s);
          return {
            score: scoreMatch ? parseInt(scoreMatch[1]) : 5,
            feedback: feedbackMatch ? feedbackMatch[1].trim() : text
          };
        } catch (error) {
          console.error('Grading error:', error);
          return { score: 5, feedback: 'æ¡ç‚¹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' };
        }
      };

      const addToReview = (item) => {
        const newItem = { ...item, id: Date.now(), addedAt: new Date().toISOString() };
        setReviewItems(prev => [...prev, newItem]);
      };

      const removeFromReview = (id) => {
        setReviewItems(prev => prev.filter(item => item.id !== id));
      };

      const selectNextTheme = () => {
        const availableThemes = activeThemes.filter((_, idx) => !usedThemes.includes(idx));
        if (availableThemes.length === 0) return null;
        const randomIndex = Math.floor(Math.random() * availableThemes.length);
        const theme = availableThemes[randomIndex];
        const originalIndex = activeThemes.findIndex(t => t.id === theme.id);
        setUsedThemes(prev => [...prev, originalIndex]);
        setCurrentThemeIndex(originalIndex);
        setCurrentQuestionLevel(0);
        return theme;
      };

      const getCurrentQuestion = () => {
        const theme = activeThemes[currentThemeIndex];
        if (!theme) return null;
        return theme.questions[currentQuestionLevel];
      };

      // è©¦é¨“é–‹å§‹ï¼ˆãƒ¢ãƒ¼ãƒ‰é¸æŠï¼‰
      const startExam = (mode) => {
        let themes = [];
        let followUps = {};
        
        if (mode === 'main') {
          // æœ¬ç·¨ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ + æ‰‹å‹•è¿½åŠ ã‚’çµ±åˆ
          themes = [...mainThemes, ...addedMainThemes];
          followUps = { ...additionalFollowUps, ...addedAdditionalQs };
        } else if (mode === 'additional') {
          // è¿½åŠ å•é¡Œç·¨ï¼šè¿½åŠ è³ªå•ã‚’å•é¡Œã¨ã—ã¦å‡ºé¡Œï¼ˆãƒ•ã‚¡ã‚¤ãƒ« + æ‰‹å‹•è¿½åŠ ï¼‰
          const allFollowUps = { ...additionalFollowUps, ...addedAdditionalQs };
          themes = Object.entries(allFollowUps).map(([q, a], idx) => ({
            id: idx + 1,
            name: `è¿½åŠ è³ªå• ${idx + 1}`,
            questions: [{
              level: 'è¿½åŠ ',
              question: q,
              modelAnswer: a,
              keyPoints: a.split(/[ã€ã€‚]/).filter(s => s.length > 5).slice(0, 3),
              followUpQuestions: []
            }]
          }));
          followUps = {};
        }
        
        if (themes.length === 0) {
          alert('å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        
        setActiveThemes(themes);
        setActiveFollowUps(followUps);
        setExamMode(mode);
        setAppMode('exam');
        setGameState('start');
        setMessages([]);
        setCurrentThemeIndex(0);
        setCurrentQuestionLevel(0);
        setCompletedThemes([]);
        setScores([]);
        setTotalScore(0);
        setFollowUpQuestion(null);
        setUsedThemes([]);
        setTakeHomeCount(0);
        setTakeHomeThemes([]);
        
        const maxThemes = Math.min(5, themes.length);
        const modeLabel = mode === 'main' ? 'æœ¬ç·¨' : 'è¿½åŠ å•é¡Œç·¨';
        
        setTimeout(() => {
          setMessages([{
            role: 'examiner',
            content: `**${modeLabel}ãƒ¢ãƒ¼ãƒ‰**ã¸ã‚ˆã†ã“ãã€‚

ğŸ“‹ **è©¦é¨“ãƒ«ãƒ¼ãƒ«**
â€¢ ${maxThemes}ã¤ã®ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦å‡ºé¡Œ
â€¢ å„å•é¡Œã¯10ç‚¹æº€ç‚¹ã§æ¡ç‚¹
â€¢ 6ç‚¹ä»¥ä¸Šã§æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸
â€¢ 5ç‚¹ä»¥ä¸‹ã§è£œè¶³è³ªå•ï¼ˆæœ¬ç·¨ã®ã¿ï¼‰

ğŸ“¦ **æŒã¡å¸°ã‚Š**: 2å›ã¾ã§
ğŸ“š **å¾©ç¿’ãƒ•ã‚©ãƒ«ãƒ€**: 5ç‚¹ä»¥ä¸‹ã¯è‡ªå‹•ä¿å­˜
âœ… **åˆæ ¼åŸºæº–**: 60%ä»¥ä¸Š

ã€Œé–‹å§‹ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`
          }]);
        }, 100);
      };

      // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰
      const startReviewExam = () => {
        if (reviewItems.length === 0) return;
        setExamMode('review');
        setAppMode('reviewExam');
        setCurrentReviewIndex(0);
        setMessages([]);
        setGameState('question');
        
        const item = reviewItems[0];
        setTimeout(() => {
          setMessages([{
            role: 'examiner',
            content: `ğŸ“š **å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰** (${reviewItems.length}å•)

**ã€${item.themeName} - ${item.level}ã€‘**
${item.question}

ğŸ’¡ å‰å›ï¼š${item.score}ç‚¹`
          }]);
        }, 100);
      };

      const handleTakeHome = () => {
        if (takeHomeCount >= MAX_TAKE_HOME) {
          setGameState('result');
          addMessage('user', 'æŒã¡å¸°ã‚‰ã›ã¦ã„ãŸã ãã¾ã™ã€‚');
          setTimeout(() => {
            const question = getCurrentQuestion();
            addMessage('examiner', `ğŸ“¦ **æŒã¡å¸°ã‚Šï¼ˆ3å›ç›®ï¼‰- ä¸åˆæ ¼**

ğŸ“– æ¨¡ç¯„è§£ç­”ï¼š${question?.modelAnswer || ''}

ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã§ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸`);
          }, 500);
          return;
        }

        const question = getCurrentQuestion();
        setTakeHomeCount(prev => prev + 1);
        setTakeHomeThemes(prev => [...prev, currentThemeIndex]);
        addMessage('user', 'æŒã¡å¸°ã‚‰ã›ã¦ã„ãŸã ãã¾ã™ã€‚');
        
        setTimeout(() => {
          addMessage('examiner', `ğŸ“¦ **æŒã¡å¸°ã‚Šï¼ˆ${takeHomeCount + 1}/${MAX_TAKE_HOME}å›ï¼‰**

ğŸ“– æ¨¡ç¯„è§£ç­”ï¼š${question?.modelAnswer}`);
          setTimeout(() => handleThemeComplete(true), 1500);
        }, 500);
      };

      const handleThemeComplete = (isTakeHome = false) => {
        if (!isTakeHome) setCompletedThemes(prev => [...prev, currentThemeIndex]);
        const maxThemes = Math.min(5, activeThemes.length);
        
        if (usedThemes.length >= maxThemes) {
          setGameState('result');
          const validScores = scores.filter(s => {
            const themeIdx = activeThemes.findIndex(t => t.name === s.theme);
            return !takeHomeThemes.includes(themeIdx);
          });
          const answeredThemeCount = maxThemes - takeHomeThemes.length - (isTakeHome ? 1 : 0);
          const maxPossibleScore = answeredThemeCount * (examMode === 'additional' ? 10 : 30);
          const actualScore = validScores.reduce((acc, s) => acc + s.score, 0);
          const percentage = maxPossibleScore > 0 ? Math.round((actualScore / maxPossibleScore) * 100) : 0;
          const passed = percentage >= 60;
          
          addMessage('examiner', `ğŸ¯ **è©¦é¨“çµ‚äº†**

ğŸ“Š **çµæœ**
å›ç­”ï¼š${answeredThemeCount}ãƒ†ãƒ¼ãƒ / æŒã¡å¸°ã‚Šï¼š${takeHomeThemes.length + (isTakeHome ? 1 : 0)}
å¾—ç‚¹ï¼š${actualScore}/${maxPossibleScore}ç‚¹ï¼ˆ${percentage}%ï¼‰

**åˆ¤å®šï¼š${passed ? 'ğŸ‰ åˆæ ¼' : 'ğŸ“š ä¸åˆæ ¼'}**

ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã§ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸`);
        } else {
          setGameState('question');
          const theme = selectNextTheme();
          if (theme) {
            const q = theme.questions[0];
            addMessage('examiner', `ğŸ“š **ãƒ†ãƒ¼ãƒ ${usedThemes.length}/${maxThemes}ï¼š${theme.name}**

ã€${q.level}å•é¡Œã€‘${q.question}`);
          }
        }
      };

      const handleSend = async () => {
        if (!inputValue.trim() || isLoading) return;
        const userInput = inputValue.trim();
        setInputValue('');
        addMessage('user', userInput);
        setIsLoading(true);

        try {
          if (userInput.includes('ãƒ¡ãƒ‹ãƒ¥ãƒ¼')) {
            setAppMode('menu');
            setIsLoading(false);
            return;
          }

          // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰
          if (appMode === 'reviewExam') {
            if (gameState === 'confirmDelete') {
              if (userInput === 'å‰Šé™¤') {
                removeFromReview(reviewItems[currentReviewIndex].id);
                addMessage('examiner', 'âœ… å‰Šé™¤ã—ã¾ã—ãŸã€‚');
              }
              const newItems = userInput === 'å‰Šé™¤' ? reviewItems.filter((_, i) => i !== currentReviewIndex) : reviewItems;
              if (newItems.length === 0 || currentReviewIndex >= newItems.length) {
                addMessage('examiner', 'ğŸ“š å¾©ç¿’å®Œäº†ï¼ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã§ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸');
                setGameState('result');
              } else {
                setGameState('question');
                const next = newItems[currentReviewIndex];
                addMessage('examiner', `**ã€${next.themeName} - ${next.level}ã€‘** (${currentReviewIndex + 1}/${newItems.length})
${next.question}
ğŸ’¡ å‰å›ï¼š${next.score}ç‚¹`);
              }
              setIsLoading(false);
              return;
            }

            const item = reviewItems[currentReviewIndex];
            const result = await gradeAnswer(item.question, item.modelAnswer, item.keyPoints || [], userInput);
            const improved = result.score > item.score;
            
            addMessage('examiner', `**${result.score}ç‚¹** ${improved ? 'ğŸ“ˆ' : ''}
${result.feedback}

ğŸ“– æ¨¡ç¯„è§£ç­”ï¼š${item.modelAnswer}`);

            setTimeout(() => {
              if (result.score >= 6) {
                addMessage('examiner', 'âœ¨ åˆæ ¼ï¼ã€Œå‰Šé™¤ã€ã§å¾©ç¿’ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰å‰Šé™¤ã€ä»–ã®å…¥åŠ›ã§æ¬¡ã¸');
                setGameState('confirmDelete');
              } else {
                if (currentReviewIndex < reviewItems.length - 1) {
                  setCurrentReviewIndex(prev => prev + 1);
                  const next = reviewItems[currentReviewIndex + 1];
                  addMessage('examiner', `**ã€${next.themeName} - ${next.level}ã€‘** (${currentReviewIndex + 2}/${reviewItems.length})
${next.question}
ğŸ’¡ å‰å›ï¼š${next.score}ç‚¹`);
                } else {
                  addMessage('examiner', 'ğŸ“š å¾©ç¿’å®Œäº†ï¼ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã§ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸');
                  setGameState('result');
                }
              }
            }, 1500);
            setIsLoading(false);
            return;
          }

          // é€šå¸¸è©¦é¨“
          if (gameState === 'start') {
            if (userInput.includes('é–‹å§‹')) {
              const theme = selectNextTheme();
              if (theme) {
                setGameState('question');
                const q = theme.questions[0];
                addMessage('examiner', `ğŸ“š **ãƒ†ãƒ¼ãƒ ${usedThemes.length}/${Math.min(5, activeThemes.length)}ï¼š${theme.name}**

ã€${q.level}å•é¡Œã€‘${q.question}`);
              }
            }
          } else if (gameState === 'question') {
            const question = getCurrentQuestion();
            if (!question) return;
            
            const result = await gradeAnswer(question.question, question.modelAnswer, question.keyPoints, userInput);
            const newScore = { theme: activeThemes[currentThemeIndex].name, level: question.level, score: result.score, addedToReview: false };
            
            if (result.score <= 5) {
              addToReview({
                themeName: activeThemes[currentThemeIndex].name,
                level: question.level,
                question: question.question,
                modelAnswer: question.modelAnswer,
                keyPoints: question.keyPoints,
                userAnswer: userInput,
                score: result.score,
                feedback: result.feedback,
                source: examMode
              });
              newScore.addedToReview = true;
            }
            
            setScores(prev => [...prev, newScore]);
            setTotalScore(prev => prev + result.score);
            
            const emoji = result.score >= 8 ? 'ğŸŒŸ' : result.score >= 6 ? 'âœ…' : 'âš ï¸';
            addMessage('examiner', `${emoji} **${result.score}ç‚¹**
${result.feedback}${result.score <= 5 ? '\nğŸ“š å¾©ç¿’ãƒ•ã‚©ãƒ«ãƒ€ã«è¿½åŠ ' : ''}

ğŸ“– æ¨¡ç¯„è§£ç­”ï¼š${question.modelAnswer}`);

            setTimeout(() => {
              if (result.score >= 6) {
                if (currentQuestionLevel < 2 && activeThemes[currentThemeIndex].questions.length > currentQuestionLevel + 1) {
                  setCurrentQuestionLevel(prev => prev + 1);
                  const nextQ = activeThemes[currentThemeIndex].questions[currentQuestionLevel + 1];
                  addMessage('examiner', `âœ¨ æ¬¡ã¸ï¼ã€${nextQ.level}å•é¡Œã€‘${nextQ.question}`);
                } else {
                  handleThemeComplete();
                }
              } else {
                // æœ¬ç·¨ã®ã¿è£œè¶³è³ªå•
                const followUp = examMode === 'main' ? question.followUpQuestions?.[0] : null;
                if (followUp) {
                  setFollowUpQuestion(followUp);
                  setGameState('followUp');
                  addMessage('examiner', `ğŸ’¡ è£œè¶³è³ªå•ï¼š**${followUp}**`);
                } else {
                  handleThemeComplete();
                }
              }
            }, 1500);
          } else if (gameState === 'followUp') {
            const expectedAnswer = activeFollowUps[followUpQuestion] || '';
            const result = await gradeAnswer(followUpQuestion, expectedAnswer || 'é©åˆ‡ãªèª¬æ˜', [], userInput);
            
            if (result.score <= 5) {
              addToReview({
                themeName: activeThemes[currentThemeIndex].name,
                level: 'è¿½åŠ è³ªå•',
                question: followUpQuestion,
                modelAnswer: expectedAnswer || 'ï¼ˆæœªç™»éŒ²ï¼‰',
                keyPoints: [],
                userAnswer: userInput,
                score: result.score,
                feedback: result.feedback,
                isFollowUp: true,
                source: examMode
              });
            }
            
            addMessage('examiner', `**${result.score}ç‚¹**
${result.feedback}
ğŸ“– æ¨¡ç¯„è§£ç­”ï¼š${expectedAnswer || 'ï¼ˆæœªç™»éŒ²ï¼‰'}`);

            setFollowUpQuestion(null);
            setTimeout(() => {
              if (result.score >= 6) {
                setGameState('question');
                if (currentQuestionLevel < 2 && activeThemes[currentThemeIndex].questions.length > currentQuestionLevel + 1) {
                  setCurrentQuestionLevel(prev => prev + 1);
                  const nextQ = activeThemes[currentThemeIndex].questions[currentQuestionLevel + 1];
                  addMessage('examiner', `âœ¨ æ¬¡ã¸ï¼ã€${nextQ.level}å•é¡Œã€‘${nextQ.question}`);
                } else {
                  handleThemeComplete();
                }
              } else {
                handleThemeComplete();
              }
            }, 1500);
          }
        } catch (error) {
          console.error('Error:', error);
          addMessage('examiner', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        } finally {
          setIsLoading(false);
        }
      };

      // æœ¬ç·¨ã«å•é¡Œè¿½åŠ 
      const handleAddMainTheme = () => {
        if (!newTheme.name.trim()) {
          alert('ãƒ†ãƒ¼ãƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        const allThemes = [...mainThemes, ...addedMainThemes];
        const newId = Math.max(...allThemes.map(t => t.id), 0) + 1;
        const themeToAdd = {
          ...newTheme,
          id: newId,
          questions: newTheme.questions.map(q => ({
            ...q,
            keyPoints: q.keyPoints.filter(k => k.trim()),
            followUpQuestions: q.followUpQuestions.filter(f => f.trim())
          }))
        };
        setAddedMainThemes(prev => [...prev, themeToAdd]);
        setNewTheme({
          name: '',
          questions: [
            { level: 'åŸºæœ¬', question: '', modelAnswer: '', keyPoints: [''], followUpQuestions: [''] },
            { level: 'è©³ç´°', question: '', modelAnswer: '', keyPoints: [''], followUpQuestions: [''] },
            { level: 'å¿œç”¨', question: '', modelAnswer: '', keyPoints: [''], followUpQuestions: [''] }
          ]
        });
        alert('æœ¬ç·¨ã«è¿½åŠ ã—ã¾ã—ãŸ');
      };

      // è¿½åŠ å•é¡Œç·¨ã«å•é¡Œè¿½åŠ 
      const handleAddAdditionalQ = () => {
        if (!newFollowUp.question.trim() || !newFollowUp.answer.trim()) {
          alert('è³ªå•ã¨å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        setAddedAdditionalQs(prev => ({ ...prev, [newFollowUp.question]: newFollowUp.answer }));
        setNewFollowUp({ question: '', answer: '' });
        alert('è¿½åŠ å•é¡Œç·¨ã«è¿½åŠ ã—ã¾ã—ãŸ');
      };

      // æœ¬ç·¨ã®è¿½åŠ å•é¡Œã‚’å‰Šé™¤
      const handleDeleteAddedMainTheme = (id) => {
        if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        setAddedMainThemes(prev => prev.filter(t => t.id !== id));
      };

      // è¿½åŠ å•é¡Œç·¨ã®è¿½åŠ å•é¡Œã‚’å‰Šé™¤
      const handleDeleteAddedAdditionalQ = (question) => {
        if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        setAddedAdditionalQs(prev => {
          const updated = { ...prev };
          delete updated[question];
          return updated;
        });
      };

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
      if (appMode === 'loading') {
        return (
          <div className="min-h-screen bg-blue-50 flex items-center justify-center">
            <div className="text-center">
              <div className="text-4xl mb-4">ğŸ“š</div>
              <p className="text-blue-700">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
          </div>
        );
      }

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      if (appMode === 'menu') {
        const allMainThemes = [...mainThemes, ...addedMainThemes];
        const mainCount = allMainThemes.reduce((a, t) => a + t.questions.length, 0);
        const allAdditionalQs = { ...additionalFollowUps, ...addedAdditionalQs };
        const additionalCount = Object.keys(allAdditionalQs).length;
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div className="max-w-2xl mx-auto pt-6">
              <div className="text-center mb-6">
                <h1 className="text-2xl font-bold text-blue-900 mb-1">åŠ´åƒè¡›ç”Ÿã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ</h1>
                <p className="text-lg text-blue-700">å£è¿°è©¦é¨“å¯¾ç­–ã‚·ã‚¹ãƒ†ãƒ </p>
              </div>
              
              <div className="space-y-3">
                {/* æœ¬ç·¨ */}
                <button 
                  onClick={() => startExam('main')} 
                  disabled={allMainThemes.length === 0}
                  className="w-full bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 text-white rounded-2xl p-5 text-left shadow-lg relative"
                >
                  <div className="flex items-center gap-4">
                    <span className="text-3xl">ğŸ“„</span>
                    <div>
                      <h2 className="text-xl font-bold">æœ¬ç·¨ï¼ˆè©³ç´°è§£èª¬ä»˜ãï¼‰</h2>
                      <p className="text-gray-200 text-sm">åŸºæœ¬â†’è©³ç´°â†’å¿œç”¨ã®3æ®µéšæ§‹æˆ</p>
                    </div>
                  </div>
                  <span className="absolute top-4 right-4 bg-blue-500 text-white text-sm font-bold px-3 py-1 rounded-full">
                    {mainCount}
                  </span>
                </button>
                
                {/* è¿½åŠ å•é¡Œç·¨ */}
                <button 
                  onClick={() => startExam('additional')} 
                  disabled={additionalCount === 0}
                  className="w-full bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 text-white rounded-2xl p-5 text-left shadow-lg relative"
                >
                  <div className="flex items-center gap-4">
                    <span className="text-3xl">ğŸ“</span>
                    <div>
                      <h2 className="text-xl font-bold">è¿½åŠ å•é¡Œç·¨</h2>
                      <p className="text-gray-200 text-sm">è£œè¶³çš„ãªå•é¡Œã§çŸ¥è­˜ã‚’è£œå¼·</p>
                    </div>
                  </div>
                  <span className="absolute top-4 right-4 bg-blue-500 text-white text-sm font-bold px-3 py-1 rounded-full">
                    {additionalCount}
                  </span>
                </button>
                
                {/* å¾©ç¿’ãƒ•ã‚©ãƒ«ãƒ€ */}
                <button 
                  onClick={() => setAppMode('review')} 
                  className="w-full bg-amber-500 hover:bg-amber-600 text-white rounded-2xl p-5 text-left shadow-lg relative"
                >
                  <div className="flex items-center gap-4">
                    <span className="text-3xl">ğŸ“š</span>
                    <div>
                      <h2 className="text-xl font-bold">å¾©ç¿’ãƒ•ã‚©ãƒ«ãƒ€</h2>
                      <p className="text-amber-100 text-sm">5ç‚¹ä»¥ä¸‹ã®å•é¡Œã‚’å¾©ç¿’</p>
                    </div>
                  </div>
                  {reviewItems.length > 0 && (
                    <span className="absolute top-4 right-4 bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full">
                      {reviewItems.length}
                    </span>
                  )}
                </button>
              </div>
              
              {/* ç®¡ç†ãƒœã‚¿ãƒ³ */}
              <div className="mt-4 flex gap-2">
                <button 
                  onClick={() => setAppMode('admin')} 
                  className="flex-1 bg-white hover:bg-gray-50 text-gray-700 rounded-xl p-3 shadow text-sm font-medium"
                >
                  âš™ï¸ å•é¡Œã‚’ç®¡ç†ãƒ»è¿½åŠ 
                </button>
              </div>
              
              {/* çµ±è¨ˆ */}
              <div className="mt-4 bg-white rounded-xl p-4 shadow">
                <h3 className="font-bold text-gray-800 mb-2 text-sm">ğŸ“Š ç™»éŒ²çŠ¶æ³</h3>
                <div className="grid grid-cols-2 gap-2 text-center text-sm">
                  <div>
                    <div className="text-xl font-bold text-gray-600">{allMainThemes.length}</div>
                    <div className="text-gray-500 text-xs">æœ¬ç·¨ãƒ†ãƒ¼ãƒ</div>
                    {addedMainThemes.length > 0 && (
                      <div className="text-green-600 text-xs">+{addedMainThemes.length} è¿½åŠ </div>
                    )}
                  </div>
                  <div>
                    <div className="text-xl font-bold text-gray-600">{additionalCount}</div>
                    <div className="text-gray-500 text-xs">è¿½åŠ å•é¡Œ</div>
                    {Object.keys(addedAdditionalQs).length > 0 && (
                      <div className="text-green-600 text-xs">+{Object.keys(addedAdditionalQs).length} è¿½åŠ </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // å¾©ç¿’ãƒ•ã‚©ãƒ«ãƒ€
      if (appMode === 'review') {
        return (
          <div className="min-h-screen bg-slate-50">
            <div className="bg-amber-500 text-white p-4">
              <div className="max-w-4xl mx-auto flex justify-between items-center">
                <h1 className="text-xl font-bold">ğŸ“š å¾©ç¿’ãƒ•ã‚©ãƒ«ãƒ€</h1>
                <button onClick={() => setAppMode('menu')} className="bg-amber-600 px-4 py-2 rounded-lg text-sm">
                  æˆ»ã‚‹
                </button>
              </div>
            </div>
            <div className="max-w-4xl mx-auto p-4">
              {reviewItems.length === 0 ? (
                <div className="bg-white rounded-xl p-8 shadow text-center">
                  <span className="text-5xl mb-4 block">ğŸ‰</span>
                  <p className="text-gray-600">å¾©ç¿’ã™ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
              ) : (
                <>
                  <div className="flex justify-between mb-4">
                    <p className="text-gray-600">{reviewItems.length}å•</p>
                    <button onClick={startReviewExam} className="bg-amber-500 text-white px-4 py-2 rounded-lg">
                      ğŸ¯ å¾©ç¿’é–‹å§‹
                    </button>
                  </div>
                  <div className="space-y-3">
                    {reviewItems.map(item => (
                      <div key={item.id} className="bg-white rounded-xl p-4 shadow">
                        <div className="flex justify-between">
                          <div>
                            <span className={`text-xs px-2 py-1 rounded mr-2 ${
                              item.source === 'main' ? 'bg-gray-100 text-gray-700' :
                              item.source === 'additional' ? 'bg-blue-100 text-blue-700' :
                              'bg-purple-100 text-purple-700'
                            }`}>
                              {item.source === 'main' ? 'æœ¬ç·¨' : item.source === 'additional' ? 'è¿½åŠ ' : 'ã‚«ã‚¹ã‚¿ãƒ '}
                            </span>
                            <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded mr-2">{item.level}</span>
                            <span className="font-medium">{item.themeName}</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-red-500 font-bold">{item.score}ç‚¹</span>
                            <button onClick={() => removeFromReview(item.id)} className="text-gray-400 hover:text-red-500">âœ•</button>
                          </div>
                        </div>
                        <p className="text-gray-700 text-sm mt-2">{item.question.substring(0, 80)}...</p>
                      </div>
                    ))}
                  </div>
                </>
              )}
            </div>
          </div>
        );
      }

      // ç®¡ç†ç”»é¢
      if (appMode === 'admin') {
        return (
          <div className="min-h-screen bg-slate-50">
            <div className="bg-gray-700 text-white p-4">
              <div className="max-w-4xl mx-auto flex justify-between items-center">
                <h1 className="text-xl font-bold">âš™ï¸ å•é¡Œç®¡ç†</h1>
                <button onClick={() => setAppMode('menu')} className="bg-gray-600 px-4 py-2 rounded-lg text-sm">
                  æˆ»ã‚‹
                </button>
              </div>
            </div>
            <div className="max-w-4xl mx-auto p-4">
              <div className="flex gap-2 mb-4 flex-wrap">
                <button
                  onClick={() => setAdminTab('addMain')}
                  className={`px-4 py-2 rounded-lg ${adminTab === 'addMain' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
                >
                  ğŸ“„ æœ¬ç·¨ã«è¿½åŠ 
                </button>
                <button
                  onClick={() => setAdminTab('addAdditional')}
                  className={`px-4 py-2 rounded-lg ${adminTab === 'addAdditional' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
                >
                  ğŸ“ è¿½åŠ å•é¡Œç·¨ã«è¿½åŠ 
                </button>
                <button
                  onClick={() => setAdminTab('listMain')}
                  className={`px-4 py-2 rounded-lg ${adminTab === 'listMain' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
                >
                  ğŸ“‹ æœ¬ç·¨ä¸€è¦§
                </button>
                <button
                  onClick={() => setAdminTab('listAdditional')}
                  className={`px-4 py-2 rounded-lg ${adminTab === 'listAdditional' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
                >
                  ğŸ“‹ è¿½åŠ å•é¡Œä¸€è¦§
                </button>
              </div>

              {/* æœ¬ç·¨ã«è¿½åŠ  */}
              {adminTab === 'addMain' && (
                <div className="bg-white rounded-xl p-6 shadow">
                  <h2 className="text-xl font-bold mb-4 text-blue-700">ğŸ“„ æœ¬ç·¨ã«å•é¡Œã‚’è¿½åŠ </h2>
                  <p className="text-gray-500 text-sm mb-4">è¿½åŠ ã—ãŸå•é¡Œã¯ã€Œæœ¬ç·¨ã€ãƒ¢ãƒ¼ãƒ‰ã§å‡ºé¡Œã•ã‚Œã¾ã™ã€‚</p>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">ãƒ†ãƒ¼ãƒå</label>
                    <input
                      type="text"
                      value={newTheme.name}
                      onChange={(e) => setNewTheme({ ...newTheme, name: e.target.value })}
                      className="w-full border rounded-lg px-4 py-2"
                      placeholder="ä¾‹: åŒ–å­¦ç‰©è³ªç®¡ç†"
                    />
                  </div>
                  {newTheme.questions.map((q, qIdx) => (
                    <div key={qIdx} className="mb-6 p-4 bg-gray-50 rounded-xl">
                      <h3 className="font-bold mb-3 text-gray-700">ã€{q.level}å•é¡Œã€‘</h3>
                      <div className="space-y-3">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">å•é¡Œæ–‡</label>
                          <textarea
                            value={q.question}
                            onChange={(e) => {
                              const updated = [...newTheme.questions];
                              updated[qIdx].question = e.target.value;
                              setNewTheme({ ...newTheme, questions: updated });
                            }}
                            className="w-full border rounded-lg px-4 py-2 h-20"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">æ¨¡ç¯„è§£ç­”</label>
                          <textarea
                            value={q.modelAnswer}
                            onChange={(e) => {
                              const updated = [...newTheme.questions];
                              updated[qIdx].modelAnswer = e.target.value;
                              setNewTheme({ ...newTheme, questions: updated });
                            }}
                            className="w-full border rounded-lg px-4 py-2 h-24"
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                  <button onClick={handleAddMainTheme} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">
                    ğŸ“„ æœ¬ç·¨ã«è¿½åŠ 
                  </button>
                </div>
              )}

              {/* è¿½åŠ å•é¡Œç·¨ã«è¿½åŠ  */}
              {adminTab === 'addAdditional' && (
                <div className="bg-white rounded-xl p-6 shadow">
                  <h2 className="text-xl font-bold mb-4 text-green-700">ğŸ“ è¿½åŠ å•é¡Œç·¨ã«è¿½åŠ </h2>
                  <p className="text-gray-500 text-sm mb-4">è¿½åŠ ã—ãŸå•é¡Œã¯ã€Œè¿½åŠ å•é¡Œç·¨ã€ãƒ¢ãƒ¼ãƒ‰ã§å‡ºé¡Œã•ã‚Œã¾ã™ã€‚</p>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">è³ªå•</label>
                      <input
                        type="text"
                        value={newFollowUp.question}
                        onChange={(e) => setNewFollowUp({ ...newFollowUp, question: e.target.value })}
                        className="w-full border rounded-lg px-4 py-2"
                        placeholder="ä¾‹: WBGTã¨ã¯ä½•ã§ã™ã‹"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">æ¨¡ç¯„è§£ç­”</label>
                      <textarea
                        value={newFollowUp.answer}
                        onChange={(e) => setNewFollowUp({ ...newFollowUp, answer: e.target.value })}
                        className="w-full border rounded-lg px-4 py-2 h-32"
                        placeholder="æ¨¡ç¯„è§£ç­”ã‚’å…¥åŠ›..."
                      />
                    </div>
                    <button onClick={handleAddAdditionalQ} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">
                      ğŸ“ è¿½åŠ å•é¡Œç·¨ã«è¿½åŠ 
                    </button>
                  </div>
                </div>
              )}

              {/* æœ¬ç·¨ä¸€è¦§ */}
              {adminTab === 'listMain' && (
                <div className="space-y-4">
                  <div className="bg-blue-50 rounded-xl p-4 border border-blue-200">
                    <h3 className="font-bold text-blue-800 mb-2">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆ{mainThemes.length}ãƒ†ãƒ¼ãƒï¼‰</h3>
                    <p className="text-blue-600 text-sm">data/questions.md ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸå•é¡Œã§ã™</p>
                  </div>
                  {mainThemes.map((theme) => (
                    <div key={theme.id} className="bg-white rounded-xl p-4 shadow border-l-4 border-gray-300">
                      <h3 className="font-bold text-gray-800">{theme.name}</h3>
                      <p className="text-gray-500 text-sm">{theme.questions.length}å•</p>
                    </div>
                  ))}
                  
                  {addedMainThemes.length > 0 && (
                    <>
                      <div className="bg-green-50 rounded-xl p-4 border border-green-200 mt-6">
                        <h3 className="font-bold text-green-800 mb-2">âœï¸ æ‰‹å‹•ã§è¿½åŠ ï¼ˆ{addedMainThemes.length}ãƒ†ãƒ¼ãƒï¼‰</h3>
                        <p className="text-green-600 text-sm">ç®¡ç†ç”»é¢ã‹ã‚‰è¿½åŠ ã—ãŸå•é¡Œã§ã™</p>
                      </div>
                      {addedMainThemes.map((theme) => (
                        <div key={theme.id} className="bg-white rounded-xl p-4 shadow border-l-4 border-green-400">
                          <div className="flex justify-between items-center">
                            <div>
                              <h3 className="font-bold text-gray-800">{theme.name}</h3>
                              <p className="text-gray-500 text-sm">{theme.questions.length}å•</p>
                            </div>
                            <button onClick={() => handleDeleteAddedMainTheme(theme.id)} className="text-red-500 text-sm">
                              å‰Šé™¤
                            </button>
                          </div>
                        </div>
                      ))}
                    </>
                  )}
                </div>
              )}

              {/* è¿½åŠ å•é¡Œä¸€è¦§ */}
              {adminTab === 'listAdditional' && (
                <div className="space-y-4">
                  <div className="bg-blue-50 rounded-xl p-4 border border-blue-200">
                    <h3 className="font-bold text-blue-800 mb-2">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆ{Object.keys(additionalFollowUps).length}å•ï¼‰</h3>
                    <p className="text-blue-600 text-sm">data/followup.md ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸå•é¡Œã§ã™</p>
                  </div>
                  <div className="bg-white rounded-xl p-4 shadow max-h-64 overflow-y-auto">
                    {Object.entries(additionalFollowUps).map(([q, a], idx) => (
                      <div key={idx} className="py-2 border-b last:border-b-0">
                        <p className="font-medium text-gray-800 text-sm">Q: {q}</p>
                        <p className="text-gray-500 text-xs mt-1">A: {a.substring(0, 60)}...</p>
                      </div>
                    ))}
                  </div>
                  
                  {Object.keys(addedAdditionalQs).length > 0 && (
                    <>
                      <div className="bg-green-50 rounded-xl p-4 border border-green-200 mt-6">
                        <h3 className="font-bold text-green-800 mb-2">âœï¸ æ‰‹å‹•ã§è¿½åŠ ï¼ˆ{Object.keys(addedAdditionalQs).length}å•ï¼‰</h3>
                        <p className="text-green-600 text-sm">ç®¡ç†ç”»é¢ã‹ã‚‰è¿½åŠ ã—ãŸå•é¡Œã§ã™</p>
                      </div>
                      <div className="bg-white rounded-xl p-4 shadow">
                        {Object.entries(addedAdditionalQs).map(([q, a], idx) => (
                          <div key={idx} className="py-2 border-b last:border-b-0 flex justify-between items-start">
                            <div>
                              <p className="font-medium text-gray-800 text-sm">Q: {q}</p>
                              <p className="text-gray-500 text-xs mt-1">A: {a.substring(0, 60)}...</p>
                            </div>
                            <button onClick={() => handleDeleteAddedAdditionalQ(q)} className="text-red-500 text-xs ml-2">
                              å‰Šé™¤
                            </button>
                          </div>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              )}
            </div>
          </div>
        );
      }

      // è©¦é¨“ç”»é¢
      const maxThemes = Math.min(5, activeThemes.length);
      const canTakeHome = appMode === 'exam' && (gameState === 'question' || gameState === 'followUp');
      const isReviewMode = appMode === 'reviewExam';
      
      return (
        <div className="flex flex-col h-screen bg-slate-50">
          <div className={`${isReviewMode ? 'bg-amber-500' : 'bg-gray-600'} text-white p-4`}>
            <div className="max-w-4xl mx-auto flex justify-between items-center">
              <h1 className="font-bold">
                {isReviewMode ? 'ğŸ“š å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰' : 
                 examMode === 'main' ? 'ğŸ“„ æœ¬ç·¨' : 'ğŸ“ è¿½åŠ å•é¡Œç·¨'}
              </h1>
              {!isReviewMode && (
                <div className="text-sm">
                  ãƒ†ãƒ¼ãƒ {usedThemes.length}/{maxThemes} | æŒã¡å¸°ã‚Šæ®‹ã‚Š {MAX_TAKE_HOME - takeHomeCount}
                </div>
              )}
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-4">
            <div className="max-w-4xl mx-auto space-y-4">
              {messages.map((msg, idx) => (
                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-3xl rounded-2xl px-4 py-3 ${
                    msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white border shadow-sm'
                  }`}>
                    <div className="whitespace-pre-wrap text-sm">
                      {msg.content.split(/(\*\*[^*]+\*\*)/).map((part, i) => 
                        part.startsWith('**') && part.endsWith('**') 
                          ? <strong key={i}>{part.slice(2, -2)}</strong> 
                          : part
                      )}
                    </div>
                  </div>
                </div>
              ))}
              {isLoading && (
                <div className="flex justify-start">
                  <div className="bg-white border rounded-2xl px-4 py-3 shadow-sm">
                    <span className="text-gray-500 text-sm">æ¡ç‚¹ä¸­...</span>
                  </div>
                </div>
              )}
              <div ref={messagesEndRef} />
            </div>
          </div>

          <div className="bg-white border-t p-4">
            <div className="max-w-4xl mx-auto flex gap-2">
              {canTakeHome && (
                <button onClick={handleTakeHome} disabled={isLoading}
                  className="px-4 py-3 rounded-xl font-semibold bg-amber-100 text-amber-700 border-2 border-amber-300">
                  ğŸ“¦ æŒã¡å¸°ã‚Š
                </button>
              )}
              <textarea
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyPress={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }}
                placeholder="å›ç­”ã‚’å…¥åŠ›..."
                className="flex-1 border rounded-xl px-4 py-3 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                rows={2}
                disabled={isLoading}
              />
              <button onClick={handleSend} disabled={isLoading || !inputValue.trim()}
                className="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 disabled:bg-gray-300">
                é€ä¿¡
              </button>
            </div>
            <p className="text-xs text-gray-500 mt-2 text-center">ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã§æˆ»ã‚‹</p>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
